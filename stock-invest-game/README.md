# 股市投資策略模擬器（台股盤中規則版）

v0.1.2

## 玩法

1. 輸入或選擇股票代號（預設 2330 台積電）
2. 按「開始監控」— 系統自動以當前價格買入 1,000 股
3. 系統每 5 秒取價並自動執行策略判斷
4. 按「停止」會強制賣出目前持有部位
5. 按「重置」清除所有統計

## 策略規則

### 持有模式
- 現價 ≤ 買入價 × 0.9 → **停損賣出**
- 現價 ≥ 買入價 × 1.1 → 進入**停利模式**

### 停利模式（移動停利）
- 持續追蹤最高價
- 現價 ≥ 最高價 × 0.998 時視為接近/突破，更新最高價
- 現價 ≤ 最高價 × 0.92 → **移動停利賣出**

### 賣出後
- 顯示本次報酬率與損益
- 累積統計：交易次數、勝率、平均報酬率、累積損益

## 時間規則

- 只在**台北時間 09:10 ~ 12:00**（週一至週五）執行策略判斷
- 非盤中時段顯示等待狀態，不執行買賣

## 資料來源（現價來源優先序與 fallback 行為）

系統依下列優先順序嘗試取得即時現價，每個來源皆有 4 秒超時保護：

| 優先序 | 來源 | 說明 |
|--------|------|------|
| 1 | **TWSE** | TWSE 公開 API (`mis.twse.com.tw`)，支援上市 (tse) 與上櫃 (otc) |
| 2 | **Yahoo** | Yahoo Finance chart endpoint (`query1.finance.yahoo.com`)，取 regularMarketPrice |
| 3 | **Stooq** | Stooq CSV endpoint (`stooq.com`)，取收盤價欄位 |
| 4 | **模擬** | 以隨機漫步產生模擬價格（±0.5%），UI 顯示黃色「模擬模式」標籤 |

### Fallback 行為
- 每次取價時從來源 1 開始嘗試，失敗即嘗試下一來源
- 若遇 CORS 問題，自動透過公開 proxy（allorigins、corsproxy.io）重試
- 所有來源皆失敗時才退回模擬模式
- UI 即時顯示當前使用的來源與最後更新時間
- 輪詢頻率可由使用者調整（預設 5 秒，最小 3 秒）
- 模擬模式下策略邏輯完全相同，僅價格為虛擬產生

## 庫存存檔（localStorage）

v0.1.2 新增自動存檔功能，關閉頁面後下次可接續。

### 存檔欄位

| 欄位 | 說明 |
|------|------|
| stock | 當前股票代號 |
| phase | 策略階段（idle / holding / trailing / sold） |
| buyPrice | 買入價 |
| highestPrice | 追蹤最高價 |
| currentPrice | 最近一次現價 |
| trades | 交易記錄（最多保留 100 筆），每筆含 buyPrice、sellPrice、pnl、returnPct、reason |
| source / sourceTime | 最後使用的來源名稱與更新時間 |
| pollSec | 輪詢間隔（秒） |

### 載入行為

- 啟動時自動從 `localStorage` 讀取存檔
- 若有持倉（holding / trailing），UI 顯示藍底提示「已載入上次庫存，可按『開始監控』繼續」
- **不會自動下單或自動開始輪詢**，須由使用者按「開始監控」繼續
- 若存檔資料格式不完整或損毀，會容錯填入預設值

### 清除存檔

- 按「清除存檔」按鈕 → 清掉 localStorage 中的持倉、統計、日誌、設定
- UI 即時回到全新初始狀態（股票代號 2330、輪詢 5 秒）

## 技術

- 純前端 HTML/CSS/JS，無需後端
- 手機友善 RWD 設計
- 無外部相依套件
- localStorage 存檔（try/catch 容錯，瀏覽器不支援時靜默降級）
