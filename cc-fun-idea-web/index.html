<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>äº¤æ˜“å“¡å£“åŠ›æ¸¬è©¦ï¼šé™æ™‚æ±ºç­–</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--card:#141b2d;--accent:#00d4aa;--danger:#ff4757;
  --warn:#ffa502;--text:#e8e8e8;--dim:#6b7b8d;--blue:#1e90ff;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100dvh;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  overflow-x:hidden;padding:12px;
}
.screen{display:none;width:100%;max-width:420px;text-align:center}
.screen.active{display:flex;flex-direction:column;align-items:center}
h1{font-size:1.6rem;margin-bottom:8px}
h2{font-size:1.3rem;margin-bottom:6px}
.subtitle{color:var(--dim);font-size:.9rem;margin-bottom:20px}
.emoji-big{font-size:3rem;margin-bottom:12px}

/* Buttons */
.btn{
  display:inline-block;padding:14px 32px;border:none;border-radius:12px;
  font-size:1.05rem;font-weight:600;cursor:pointer;
  transition:transform .1s,opacity .1s;color:#fff;
  -webkit-tap-highlight-color:transparent;
}
.btn:active{transform:scale(.95);opacity:.85}
.btn-primary{background:linear-gradient(135deg,var(--accent),#00b894)}
.btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent)}

/* Start screen */
#startScreen .rules{
  background:var(--card);border-radius:14px;padding:16px 18px;
  text-align:left;margin-bottom:24px;width:100%;
}
#startScreen .rules li{
  margin:6px 0;font-size:.9rem;color:var(--dim);list-style:none;
  padding-left:20px;position:relative;
}
#startScreen .rules li::before{content:">";position:absolute;left:0;color:var(--accent)}

/* Difficulty selector */
.difficulty-section{width:100%;margin-bottom:20px}
.difficulty-label{font-size:.95rem;color:var(--dim);margin-bottom:10px}
.difficulty-group{display:flex;gap:10px;width:100%}
.diff-btn{
  flex:1;background:var(--card);border:2px solid #2a3548;border-radius:12px;
  padding:12px 6px;cursor:pointer;text-align:center;
  transition:border-color .15s,background .15s;
  -webkit-tap-highlight-color:transparent;color:var(--text);
}
.diff-btn:active{transform:scale(.97)}
.diff-btn.selected{border-color:var(--accent);background:rgba(0,212,170,.1)}
.diff-btn .diff-name{font-size:1rem;font-weight:700;margin-bottom:4px}
.diff-btn .diff-time{font-size:.8rem;color:var(--dim)}
.diff-btn.selected .diff-time{color:var(--accent)}

/* Game screen */
#gameScreen{gap:10px}
.top-bar{
  display:flex;justify-content:space-between;align-items:center;
  width:100%;padding:6px 4px;
}
.progress-text{font-size:.85rem;color:var(--dim)}
.score-text{font-size:.85rem;color:var(--accent);font-weight:600}
.level-badge{
  display:inline-block;background:rgba(0,212,170,.15);color:var(--accent);
  font-size:.75rem;padding:3px 10px;border-radius:20px;font-weight:600;
}
.timer-ring{
  position:relative;width:70px;height:70px;margin:4px auto;
}
.timer-ring svg{transform:rotate(-90deg);width:70px;height:70px}
.timer-ring circle{
  fill:none;stroke-width:5;cx:35;cy:35;r:30;
}
.timer-ring .bg{stroke:#1e2a3a}
.timer-ring .fg{
  stroke:var(--accent);stroke-linecap:round;
  stroke-dasharray:188.5;stroke-dashoffset:0;
  transition:stroke-dashoffset .15s linear,stroke .3s;
}
.timer-ring .fg.warn{stroke:var(--warn)}
.timer-ring .fg.danger{stroke:var(--danger)}
.timer-num{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:1.5rem;font-weight:700;
}
.question-card{
  background:var(--card);border-radius:16px;padding:18px 16px;
  width:100%;min-height:100px;display:flex;flex-direction:column;
  justify-content:center;
}
.q-tag{
  display:inline-block;background:rgba(0,212,170,.15);color:var(--accent);
  font-size:.75rem;padding:3px 10px;border-radius:20px;margin-bottom:8px;
  align-self:flex-start;
}
.q-text{font-size:1.05rem;line-height:1.5}
.options{display:flex;flex-direction:column;gap:10px;width:100%}
.opt-btn{
  background:var(--card);border:2px solid #2a3548;border-radius:12px;
  padding:14px 16px;font-size:1rem;color:var(--text);cursor:pointer;
  text-align:left;transition:border-color .15s,background .15s;
  -webkit-tap-highlight-color:transparent;
}
.opt-btn:active{border-color:var(--accent)}
.opt-btn.correct{border-color:var(--accent);background:rgba(0,212,170,.12)}
.opt-btn.wrong{border-color:var(--danger);background:rgba(255,71,87,.12)}
.opt-btn.reveal{border-color:var(--accent);opacity:.6}
.opt-btn.disabled{pointer-events:none}
.explanation{
  background:rgba(30,144,255,.08);border-left:3px solid var(--blue);
  border-radius:0 10px 10px 0;padding:10px 14px;width:100%;
  text-align:left;font-size:.88rem;line-height:1.5;color:var(--dim);
  min-height:40px;
}
.explanation .verdict{font-weight:700;margin-bottom:2px}
.explanation .verdict.ok{color:var(--accent)}
.explanation .verdict.ng{color:var(--danger)}
.explanation .verdict.timeout{color:var(--warn)}

/* Result screen */
#resultScreen{gap:14px}
.result-card{
  background:var(--card);border-radius:18px;padding:24px 20px;width:100%;
}
.result-score{font-size:2.8rem;font-weight:800;color:var(--accent)}
.result-rank{font-size:1.3rem;margin-top:4px}
.result-msg{color:var(--dim);font-size:.92rem;margin-top:10px;line-height:1.5}
.result-level{color:var(--accent);font-size:.85rem;margin-top:8px;font-weight:600}
.result-stats{
  display:flex;justify-content:space-around;margin-top:18px;
  border-top:1px solid #1e2a3a;padding-top:14px;
}
.stat{text-align:center}
.stat-val{font-size:1.4rem;font-weight:700}
.stat-label{font-size:.75rem;color:var(--dim);margin-top:2px}
.result-btns{display:flex;gap:12px;width:100%;margin-top:6px}
.result-btns .btn{flex:1}

/* Shake animation */
@keyframes shake{
  0%,100%{transform:translateX(0)}
  20%,60%{transform:translateX(-4px)}
  40%,80%{transform:translateX(4px)}
}
.shake{animation:shake .35s}
/* Pulse */
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.pulse{animation:pulse .4s}
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen" class="screen active">
  <div class="emoji-big">ğŸ“ˆ</div>
  <h1>äº¤æ˜“å“¡å£“åŠ›æ¸¬è©¦</h1>
  <p class="subtitle">é™æ™‚æ±ºç­– â”€ ä½ æ’å¾—ä½ç›¤ä¸­å£“åŠ›å—ï¼Ÿ</p>
  <div class="rules">
    <li>å…± 10 é¡Œï¼Œä¾é›£åº¦é™æ™‚ä½œç­”</li>
    <li>é¡Œå‹ï¼šæ¼²è·Œå¹… / åœæå€‰ä½ / é¢¨éšªå ±é…¬ / æ»‘åƒ¹</li>
    <li>ç­”å°å¾—åˆ†ï¼Œç­”éŒ¯æˆ–è¶…æ™‚ä¸å¾—åˆ†</li>
    <li>æœ€çµ‚ä¾ç¸½åˆ†è©•å®šç­‰ç´š</li>
  </div>
  <div class="difficulty-section">
    <div class="difficulty-label">é¸æ“‡é›£åº¦</div>
    <div class="difficulty-group">
      <button class="diff-btn" data-time="20" onclick="selectDifficulty(this)">
        <div class="diff-name">ğŸŸ¢ å…¥é–€</div>
        <div class="diff-time">æ¯é¡Œ 20 ç§’</div>
      </button>
      <button class="diff-btn selected" data-time="10" onclick="selectDifficulty(this)">
        <div class="diff-name">ğŸŸ¡ å°ˆå®¶</div>
        <div class="diff-time">æ¯é¡Œ 10 ç§’</div>
      </button>
      <button class="diff-btn" data-time="5" onclick="selectDifficulty(this)">
        <div class="diff-name">ğŸ”´ å¿«æ‰‹</div>
        <div class="diff-time">æ¯é¡Œ 5 ç§’</div>
      </button>
    </div>
  </div>
  <button class="btn btn-primary" onclick="startGame()">é–‹å§‹æ¸¬è©¦</button>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <div class="top-bar">
    <span class="progress-text" id="progressText">1 / 10</span>
    <span class="level-badge" id="levelBadge">å°ˆå®¶ Â· 10s</span>
    <span class="score-text" id="scoreText">0 åˆ†</span>
  </div>
  <div class="timer-ring" id="timerRing">
    <svg><circle class="bg"/><circle class="fg" id="timerCircle"/></svg>
    <span class="timer-num" id="timerNum">10</span>
  </div>
  <div class="question-card" id="questionCard">
    <span class="q-tag" id="qTag"></span>
    <p class="q-text" id="qText"></p>
  </div>
  <div class="options" id="optionsDiv"></div>
  <div class="explanation" id="explanationDiv" style="visibility:hidden"></div>
</div>

<!-- RESULT SCREEN -->
<div id="resultScreen" class="screen">
  <div class="emoji-big" id="resultEmoji">ğŸ†</div>
  <div class="result-card">
    <div class="result-score" id="resultScore">0</div>
    <div class="result-rank" id="resultRank"></div>
    <div class="result-msg" id="resultMsg"></div>
    <div class="result-level" id="resultLevel"></div>
    <div class="result-stats">
      <div class="stat"><div class="stat-val" id="statCorrect" style="color:var(--accent)">0</div><div class="stat-label">ç­”å°</div></div>
      <div class="stat"><div class="stat-val" id="statWrong" style="color:var(--danger)">0</div><div class="stat-label">ç­”éŒ¯</div></div>
      <div class="stat"><div class="stat-val" id="statTimeout" style="color:var(--warn)">0</div><div class="stat-label">è¶…æ™‚</div></div>
    </div>
  </div>
  <div class="result-btns">
    <button class="btn btn-primary" onclick="backToStart()">å†ç©ä¸€æ¬¡</button>
  </div>
</div>

<script>
// ===== Question Bank =====
const QUESTIONS = [
  // --- æ¼²è·Œå¹… ---
  {
    tag:"æ¼²è·Œå¹…",
    text:"æŸè‚¡æ˜¨æ”¶ 100 å…ƒï¼Œä»Šæ—¥æ”¶ç›¤ 107 å…ƒï¼Œæ¼²å¹…ç‚ºï¼Ÿ",
    opts:["5%","7%","10%","3%"],
    ans:1,
    exp:"æ¼²å¹… = (107-100)/100 = 7%"
  },
  {
    tag:"æ¼²è·Œå¹…",
    text:"æŸè‚¡å¾ 80 å…ƒè·Œåˆ° 72 å…ƒï¼Œè·Œå¹…ç‚ºï¼Ÿ",
    opts:["-8%","-10%","-12%","-15%"],
    ans:1,
    exp:"è·Œå¹… = (72-80)/80 = -10%"
  },
  {
    tag:"æ¼²è·Œå¹…",
    text:"æŸè‚¡é€£å…©å¤©å„æ¼² 10%ï¼Œå…©å¤©ç´¯è¨ˆæ¼²å¹…ç‚ºï¼Ÿ",
    opts:["20%","21%","19%","22%"],
    ans:1,
    exp:"1.1 x 1.1 = 1.21ï¼Œç´¯è¨ˆæ¼² 21%ï¼Œä¸æ˜¯ç°¡å–®ç›¸åŠ ã€‚"
  },
  {
    tag:"æ¼²è·Œå¹…",
    text:"æŸè‚¡å…ˆè·Œ 20% å†æ¼² 20%ï¼Œæœ€çµ‚å ±é…¬ç‚ºï¼Ÿ",
    opts:["0%","-4%","+4%","-2%"],
    ans:1,
    exp:"0.8 x 1.2 = 0.96ï¼Œå¯¦éš›è™§æ 4%ã€‚è·Œæ·±åå½ˆæœªå¿…å›æœ¬ã€‚"
  },
  {
    tag:"æ¼²è·Œå¹…",
    text:"æŸè‚¡æ˜¨æ”¶ 50 å…ƒï¼Œä»Šæ—¥æœ€é«˜ 55ã€æ”¶ç›¤ 52ï¼Œç•¶æ—¥æ¼²å¹…ç‚ºï¼Ÿ",
    opts:["10%","4%","6%","2%"],
    ans:1,
    exp:"æ¼²å¹…ä»¥æ”¶ç›¤åƒ¹è¨ˆç®—ï¼š(52-50)/50 = 4%"
  },
  // --- åœæå€‰ä½ ---
  {
    tag:"åœæå€‰ä½",
    text:"å¸³æˆ¶ 100 è¬ï¼Œå–®ç­†æœ€å¤§è™§ææ§åˆ¶åœ¨ 2%ï¼Œæœ€å¤šèƒ½è™§å¤šå°‘ï¼Ÿ",
    opts:["1 è¬","2 è¬","5 è¬","10 è¬"],
    ans:1,
    exp:"100 è¬ x 2% = 2 è¬ï¼Œé€™æ˜¯å¸¸è¦‹çš„å–®ç­†é¢¨æ§ä¸Šé™ã€‚"
  },
  {
    tag:"åœæå€‰ä½",
    text:"è²·é€²åƒ¹ 50 å…ƒï¼Œåœæè¨­ 45 å…ƒï¼Œåœæå¹…åº¦ç‚ºï¼Ÿ",
    opts:["-5%","-10%","-8%","-12%"],
    ans:1,
    exp:"(45-50)/50 = -10%"
  },
  {
    tag:"åœæå€‰ä½",
    text:"å¸³æˆ¶ 200 è¬ï¼Œæœ€å¤§è™§æ 2%ï¼ˆ4 è¬ï¼‰ï¼Œè‚¡åƒ¹ 100 åœæ 95ï¼Œæœ€å¤šè²·å¹¾å¼µï¼Ÿ",
    opts:["6 å¼µ","8 å¼µ","10 å¼µ","4 å¼µ"],
    ans:1,
    exp:"æ¯å¼µè™§ 5 å…ƒ x 1000 è‚¡ = 5000ï¼Œ4 è¬ / 5000 = 8 å¼µã€‚"
  },
  {
    tag:"åœæå€‰ä½",
    text:"ä½ åœ¨ 200 å…ƒåšå¤šï¼Œç›®æ¨™ 230ã€åœæ 190ï¼Œé¢¨éšªå ±é…¬æ¯”ç‚ºï¼Ÿ",
    opts:["1:2","1:3","1:1.5","2:1"],
    ans:1,
    exp:"é¢¨éšª 10 å…ƒï¼Œå ±é…¬ 30 å…ƒï¼Œé¢¨å ±æ¯” 1:3ã€‚"
  },
  {
    tag:"åœæå€‰ä½",
    text:"é€£çºŒåœæ 5 æ¬¡ï¼Œæ¯æ¬¡è™§å¸³æˆ¶ 2%ï¼Œå‰©é¤˜è³‡é‡‘ç´„ç‚ºåŸå§‹çš„å¹¾ %ï¼Ÿ",
    opts:["90%","88%","92%","85%"],
    ans:0,
    exp:"0.98^5 â‰ˆ 0.9039ï¼Œç´„å‰© 90%ã€‚è¤‡åˆ©æ•ˆæ‡‰è®“å¯¦éš›è™§æç•¥å¤šæ–¼ 10%ã€‚"
  },
  // --- é¢¨éšªå ±é…¬ ---
  {
    tag:"é¢¨éšªå ±é…¬",
    text:"å‹ç‡ 40%ã€ç›ˆè™§æ¯” 3:1ï¼Œé•·æœŸæœŸæœ›å€¼ç‚ºï¼Ÿ",
    opts:["æ­£æœŸæœ›","è² æœŸæœ›","æ‰“å¹³","ç„¡æ³•åˆ¤æ–·"],
    ans:0,
    exp:"æœŸæœ›å€¼ = 0.4x3 - 0.6x1 = 0.6 > 0ï¼Œæ­£æœŸæœ›ç­–ç•¥ã€‚"
  },
  {
    tag:"é¢¨éšªå ±é…¬",
    text:"æŸç­–ç•¥å‹ç‡ 70%ï¼Œæ¯æ¬¡è³º 1 å…ƒã€è™§ 3 å…ƒï¼ŒæœŸæœ›å€¼ï¼Ÿ",
    opts:["æ­£æœŸæœ›","è² æœŸæœ›","æ‰“å¹³","è¦çœ‹å¸‚å ´"],
    ans:1,
    exp:"0.7x1 - 0.3x3 = 0.7-0.9 = -0.2ï¼Œè² æœŸæœ›å€¼ã€‚é«˜å‹ç‡ä¸ä»£è¡¨è³ºéŒ¢ã€‚"
  },
  {
    tag:"é¢¨éšªå ±é…¬",
    text:"ä½ çš„ç­–ç•¥é¢¨å ±æ¯” 1:2ï¼Œè¦é”åˆ°æ­£æœŸæœ›å€¼ï¼Œå‹ç‡è‡³å°‘éœ€è¦ï¼Ÿ",
    opts:["è¶…é 50%","è¶…é 33%","è¶…é 25%","è¶…é 40%"],
    ans:1,
    exp:"è¨­å‹ç‡ pï¼š2p - 1(1-p) = 0 â†’ p = 1/3 â‰ˆ 33%ã€‚é¢¨å ±æ¯”è¶Šé«˜ï¼Œæ‰€éœ€å‹ç‡è¶Šä½ã€‚"
  },
  {
    tag:"é¢¨éšªå ±é…¬",
    text:"å…©ç­–ç•¥ï¼šA å‹ç‡ 80% ç›ˆè™§æ¯” 0.5:1ï¼ŒB å‹ç‡ 45% ç›ˆè™§æ¯” 2.5:1ï¼Œå“ªå€‹æœŸæœ›å€¼è¼ƒé«˜ï¼Ÿ",
    opts:["A è¼ƒé«˜","B è¼ƒé«˜","ä¸€æ¨£","ç„¡æ³•æ¯”è¼ƒ"],
    ans:1,
    exp:"A: 0.8x0.5-0.2x1=-0.2+0.4=0.2 B: 0.45x2.5-0.55x1=1.125-0.55=0.575ã€‚B è¼ƒé«˜ã€‚"
  },
  // --- æ»‘åƒ¹åˆ¤æ–· ---
  {
    tag:"æ»‘åƒ¹åˆ¤æ–·",
    text:"ä½ æ›å¸‚åƒ¹å–®è²·é€²ï¼Œå§”è²· 50.0/å§”è³£ 50.5ï¼Œæœ€å¯èƒ½æˆäº¤åƒ¹ï¼Ÿ",
    opts:["50.0","50.5","50.25","49.5"],
    ans:1,
    exp:"å¸‚åƒ¹è²·å–®åƒå°æ‰‹æ–¹ï¼ˆå§”è³£ï¼‰ï¼Œæˆäº¤åœ¨ 50.5 é™„è¿‘ã€‚"
  },
  {
    tag:"æ»‘åƒ¹åˆ¤æ–·",
    text:"å¤§é‡å¸‚åƒ¹è³£å–®æ¹§å…¥ï¼Œå§”è²·ç°¿åªæœ‰è–„è–„å¹¾æª”ï¼Œæœ€å¯èƒ½ç™¼ç”Ÿï¼Ÿ",
    opts:["åƒ¹æ ¼ä¸è®Š","å¤§å¹…ä¸‹æ»‘åƒ¹","æˆäº¤é‡æ¸›å°‘","è‡ªå‹•åœç‰Œ"],
    ans:1,
    exp:"è–„å§”è²·è¢«å¤§å–®æƒç©¿ï¼Œé€ æˆå¤§å¹…æ»‘åƒ¹ï¼ˆslippageï¼‰ã€‚"
  },
  {
    tag:"æ»‘åƒ¹åˆ¤æ–·",
    text:"è¦æ¸›å°‘æ»‘åƒ¹ï¼Œä»¥ä¸‹å“ªç¨®ä¸‹å–®æ–¹å¼è¼ƒä½³ï¼Ÿ",
    opts:["å¸‚åƒ¹å–®","é™åƒ¹å–®","é‰…é¡å¸‚åƒ¹","è¿½åƒ¹å–®"],
    ans:1,
    exp:"é™åƒ¹å–®å¯æ§åˆ¶æˆäº¤åƒ¹æ ¼ï¼Œé¿å…æ»‘åƒ¹é¢¨éšªã€‚"
  },
  {
    tag:"æ»‘åƒ¹åˆ¤æ–·",
    text:"æµå‹•æ€§æ¥µå·®çš„è‚¡ç¥¨ï¼Œæ›å¸‚åƒ¹å–® 1000 å¼µè³£å‡ºï¼Œæœ€å¯èƒ½çµæœï¼Ÿ",
    opts:["ç«‹å³å…¨æ•¸æˆäº¤","åš´é‡æ»‘åƒ¹æˆäº¤","éƒ¨åˆ†æˆäº¤","ç³»çµ±æ‹’çµ•"],
    ans:1,
    exp:"æµå‹•æ€§å·® + å¤§é‡å¸‚åƒ¹ â†’ æ‰“ç©¿å¤šæª”å§”è²·ï¼Œåš´é‡æ»‘åƒ¹ã€‚"
  },
  {
    tag:"æ»‘åƒ¹åˆ¤æ–·",
    text:"ç›¤å‰ç«¶åƒ¹æ™‚æ®µï¼Œæ»‘åƒ¹é¢¨éšªç›¸æ¯”ç›¤ä¸­é€£çºŒæ’®åˆé€šå¸¸ï¼Ÿ",
    opts:["è¼ƒä½","è¼ƒé«˜","ä¸€æ¨£","æ²’æœ‰æ»‘åƒ¹"],
    ans:1,
    exp:"ç›¤å‰ç«¶åƒ¹æ˜¯é›†åˆç«¶åƒ¹ï¼Œä¸€æ¬¡æ’®åˆæˆä¸€å€‹åƒ¹æ ¼ï¼Œç›¸æ¯”é€£çºŒæ’®åˆæ»‘åƒ¹é¢¨éšªè¼ƒé«˜ã€‚"
  },
  // more mixed
  {
    tag:"æ¼²è·Œå¹…",
    text:"å°è‚¡æ¼²åœæ¿ 10%ï¼ŒæŸè‚¡æ˜¨æ”¶ 150 å…ƒï¼Œæ¼²åœåƒ¹ç‚ºï¼Ÿ",
    opts:["160 å…ƒ","165 å…ƒ","155 å…ƒ","170 å…ƒ"],
    ans:1,
    exp:"150 x 1.1 = 165 å…ƒã€‚"
  },
];

// ===== Difficulty Config =====
const DIFFICULTIES = {
  20: {name:'å…¥é–€', icon:'ğŸŸ¢'},
  10: {name:'å°ˆå®¶', icon:'ğŸŸ¡'},
  5:  {name:'å¿«æ‰‹', icon:'ğŸ”´'},
};

// ===== State =====
let questions=[], current=0, score=0, timer=null, timeLeft=0;
let correctCount=0, wrongCount=0, timeoutCount=0;
let answered=false;
let selectedTimeLimit=10; // default: å°ˆå®¶
const TOTAL=10;
const CIRCUM=2*Math.PI*30; // ~188.5

// ===== Helpers =====
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function pickQuestions(){
  // group by tag, pick balanced
  const byTag={};
  QUESTIONS.forEach(q=>{
    if(!byTag[q.tag])byTag[q.tag]=[];
    byTag[q.tag].push(q);
  });
  const tags=Object.keys(byTag);
  tags.forEach(t=>shuffle(byTag[t]));
  const picked=[];
  let idx=0;
  while(picked.length<TOTAL){
    const t=tags[idx%tags.length];
    if(byTag[t].length>0) picked.push(byTag[t].pop());
    idx++;
    if(tags.every(t2=>byTag[t2].length===0)) break;
  }
  return shuffle(picked);
}

// ===== Difficulty Selection =====
function selectDifficulty(btn){
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedTimeLimit=parseInt(btn.dataset.time,10);
}

function backToStart(){
  show('startScreen');
}

// ===== Game Flow =====
function startGame(){
  questions=pickQuestions();
  current=0;score=0;
  correctCount=0;wrongCount=0;timeoutCount=0;

  // Update level badge in game screen
  const diff=DIFFICULTIES[selectedTimeLimit];
  document.getElementById('levelBadge').textContent=diff.icon+' '+diff.name+' Â· '+selectedTimeLimit+'s';

  show('gameScreen');
  loadQuestion();
}

function loadQuestion(){
  answered=false;
  const q=questions[current];
  document.getElementById('progressText').textContent=`${current+1} / ${TOTAL}`;
  document.getElementById('scoreText').textContent=`${score} åˆ†`;
  document.getElementById('qTag').textContent=q.tag;
  document.getElementById('qText').textContent=q.text;

  // Shuffle option order and track correct answer's new position
  const indices=[0,1,2,3];
  shuffle(indices);
  q._shuffledAns=indices.indexOf(q.ans);

  const optDiv=document.getElementById('optionsDiv');
  optDiv.innerHTML='';
  indices.forEach((origIdx,i)=>{
    const btn=document.createElement('button');
    btn.className='opt-btn';
    btn.textContent=q.opts[origIdx];
    btn.onclick=()=>answer(i);
    optDiv.appendChild(btn);
  });

  const expDiv=document.getElementById('explanationDiv');
  expDiv.style.visibility='hidden';
  expDiv.innerHTML='';

  startTimer();
}

function startTimer(){
  timeLeft=selectedTimeLimit;
  updateTimerDisplay();
  const circle=document.getElementById('timerCircle');
  circle.classList.remove('warn','danger');
  circle.style.strokeDashoffset='0';

  if(timer) clearInterval(timer);
  const start=Date.now();
  timer=setInterval(()=>{
    const elapsed=(Date.now()-start)/1000;
    timeLeft=Math.max(0,selectedTimeLimit-elapsed);
    updateTimerDisplay();

    if(timeLeft<=0){
      clearInterval(timer);
      if(!answered) onTimeout();
    }
  },50);
}

function updateTimerDisplay(){
  const circle=document.getElementById('timerCircle');
  const num=document.getElementById('timerNum');
  const ratio=timeLeft/selectedTimeLimit;
  circle.style.strokeDashoffset=((1-ratio)*CIRCUM).toString();
  num.textContent=Math.ceil(timeLeft);

  circle.classList.remove('warn','danger');
  // Adaptive thresholds based on time limit
  const dangerAt=selectedTimeLimit<=5?2:selectedTimeLimit<=10?3:5;
  const warnAt=selectedTimeLimit<=5?3:selectedTimeLimit<=10?5:10;
  if(timeLeft<=dangerAt) circle.classList.add('danger');
  else if(timeLeft<=warnAt) circle.classList.add('warn');
}

function answer(idx){
  if(answered) return;
  answered=true;
  clearInterval(timer);

  const q=questions[current];
  const correctIdx=q._shuffledAns;
  const btns=document.querySelectorAll('#optionsDiv .opt-btn');
  btns.forEach(b=>b.classList.add('disabled'));

  const isCorrect=idx===correctIdx;
  if(isCorrect){
    score+=10;
    correctCount++;
    btns[idx].classList.add('correct');
    document.getElementById('questionCard').classList.add('pulse');
  }else{
    wrongCount++;
    btns[idx].classList.add('wrong');
    btns[correctIdx].classList.add('reveal');
    document.getElementById('questionCard').classList.add('shake');
  }

  document.getElementById('scoreText').textContent=`${score} åˆ†`;
  showExplanation(isCorrect?'ok':'ng', q.exp);
  setTimeout(()=>{
    document.getElementById('questionCard').classList.remove('pulse','shake');
    nextQuestion();
  },2000);
}

function onTimeout(){
  answered=true;
  timeoutCount++;
  const q=questions[current];
  const btns=document.querySelectorAll('#optionsDiv .opt-btn');
  btns.forEach(b=>b.classList.add('disabled'));
  btns[q._shuffledAns].classList.add('reveal');
  document.getElementById('questionCard').classList.add('shake');
  showExplanation('timeout', q.exp);
  setTimeout(()=>{
    document.getElementById('questionCard').classList.remove('shake');
    nextQuestion();
  },2000);
}

function showExplanation(type, text){
  const div=document.getElementById('explanationDiv');
  let label='';
  if(type==='ok') label='<div class="verdict ok">âœ“ æ­£ç¢ºï¼</div>';
  else if(type==='ng') label='<div class="verdict ng">âœ— ç­”éŒ¯äº†</div>';
  else label='<div class="verdict timeout">â° æ™‚é–“åˆ°ï¼</div>';
  div.innerHTML=label+'<div>'+text+'</div>';
  div.style.visibility='visible';
}

function nextQuestion(){
  current++;
  if(current>=TOTAL){
    showResult();
  }else{
    loadQuestion();
  }
}

// ===== Result =====
function showResult(){
  show('resultScreen');
  document.getElementById('resultScore').textContent=score;
  document.getElementById('statCorrect').textContent=correctCount;
  document.getElementById('statWrong').textContent=wrongCount;
  document.getElementById('statTimeout').textContent=timeoutCount;

  const diff=DIFFICULTIES[selectedTimeLimit];
  document.getElementById('resultLevel').textContent='é›£åº¦ï¼š'+diff.icon+' '+diff.name+'ï¼ˆæ¯é¡Œ '+selectedTimeLimit+' ç§’ï¼‰';

  let rank='',emoji='',msg='';
  if(score>=90){
    rank='ğŸ† è€å¸æ©Ÿ';emoji='ğŸ†';
    msg='ä½ çš„ç›¤æ„Ÿèˆ‡é¢¨æ§æ„è­˜æ¥µå¼·ï¼Œé¢å°é«˜å£“ç›¤å‹¢ä¹Ÿèƒ½å†·éœåˆ¤æ–·ã€‚ç¹¼çºŒä¿æŒï¼';
  }else if(score>=60){
    rank='ğŸ“Š ç©©å¥äº¤æ˜“å“¡';emoji='ğŸ“Š';
    msg='åŸºæœ¬åŠŸç´®å¯¦ï¼Œä½†åœ¨å£“åŠ›ä¸‹å¶æœ‰å¤±èª¤ã€‚å¤šç·´ç¿’é™æ™‚æ±ºç­–ï¼Œä½ æœƒæ›´ä¸Šä¸€å±¤æ¨“ï¼';
  }else{
    rank='ğŸ“– æ–°æ‰‹äº¤æ˜“å“¡';emoji='ğŸ“–';
    msg='äº¤æ˜“è·¯ä¸Šäººäººéƒ½æ˜¯å¾æ–°æ‰‹é–‹å§‹ã€‚å»ºè­°å›é¡§é¢¨æ§åŸºç¤ï¼Œç©©æ‰ç©©æ‰“ï¼';
  }
  document.getElementById('resultEmoji').textContent=emoji;
  document.getElementById('resultRank').textContent=rank;
  document.getElementById('resultMsg').textContent=msg;
}
</script>
</body>
</html>
