# 股市投資策略工具（台股盤中規則版）

v0.2.0

## 玩法

1. 輸入或選擇股票代號（預設 2330 台積電）
2. 設定監控時窗（預設 09:10~12:00，Asia/Taipei 時區）
3. 按「手動買入」— 輸入買入價（留空=現價）與股數，手動進場後自動監控賣出
4. 或按「開始監控」— 等待監控時窗內手動買入
5. 系統每 N 秒取價並在監控時窗內自動執行策略判斷
6. 按「停止監控」只停止輪詢，持倉保留不賣出
7. 按「手動賣出」可在任何時候手動平倉（僅有持倉時可用）
8. 按「重置」清除所有統計

## 策略規則

### 持有模式
- 現價 ≤ 買入價 × 0.9 → **停損賣出**
- 現價 ≥ 買入價 × 1.1 → 進入**停利模式**

### 停利模式（移動停利）
- 持續追蹤最高價
- 現價 ≥ 最高價 × 0.998 時視為接近/突破，更新最高價
- 現價 ≤ 最高價 × 0.92 → **移動停利賣出**

### 賣出後
- 顯示本次報酬率與損益
- 累積統計：交易次數、勝率、平均報酬率、累積損益

## 指定監控時間（v0.1.4 新增）

- 可自訂監控起始時間（預設 09:10）與結束時間（預設 12:00）
- 時區固定 Asia/Taipei，週六日不執行
- 只在設定的時窗內執行策略判斷，時窗外顯示等待
- 設定值會存入 localStorage，重新開啟頁面保留

## 手動買入與自動監控賣出（v0.1.4 新增）

- 按「手動買入」按鈕，可輸入買入價格（留空則使用當前現價）與股數（預設 1000）
- 手動買入後進入持有狀態（holding），自動啟動監控與賣出邏輯
- 若已有持倉，禁止重複買入並彈出提示
- 持倉來源（手動買入 / 自動買入）會顯示在即時狀態面板與庫存查詢彈窗
- 賣出邏輯沿用原策略：停損 / 進停利模式 / 移動停利

## 多次買入 / 分筆檢測 / 分筆賣出（v0.1.6 新增）

### 多倉位模型（lots）
- 每次「手動買入」新增一筆獨立倉位（lot），不再限制只能持有一筆
- 每筆 lot 包含：lotId、股票、股數、買入價、最高價、phase（holding/trailing/sold）、買入時間
- 不同 lot 的策略判斷彼此獨立，同一時刻可有多筆 lot 觸發不同動作

### 每筆獨立策略
- 對每個 active lot（holding/trailing）逐筆套用原規則：
  - 停損：現價 ≤ 買入價 × 0.9
  - 進入停利：現價 ≥ 買入價 × 1.1
  - 停利模式追高：現價 ≥ 最高價 × 0.998 更新最高
  - 移動停利：現價 ≤ 最高價 × 0.92 觸發賣出

### UI 持倉清單
- 新增「持倉清單」面板，列出所有 active lots：lotId、買入價、股數、狀態、最高價、未實現損益%
- 每筆 lot 後面有「賣出」按鈕，可單筆手動賣出
- 多於一筆時顯示「賣出全部」按鈕
- 查詢庫存彈窗改為顯示多筆持倉明細與總持倉/總損益/總報酬率

### 手動賣出
- 上方「賣出全部」按鈕：一次賣出所有 active lots
- 持倉清單內每筆 lot 的「賣出」按鈕：單筆賣出
- 每筆賣出獨立計入交易記錄與統計

### 存檔相容
- localStorage 升級為 v2 lots 結構
- 自動相容舊版 v1 單倉位存檔（升級轉換為 lots 陣列）

## UI 收斂 — 全域摘要 + Lot 看板（v0.2.0 新增）

### 變更原因

v0.1.9 之前的「即時狀態」面板（股票、現價、買入價、最高價、股數、來源、狀態、報酬率）
與 Lot 看板顯示的資訊高度重複。多筆持倉時，舊面板只能用平均值摘要，反而造成混淆。
v0.2.0 移除舊即時狀態面板，改為一行式全域摘要，配合 Lot 看板作為主視圖。

### 全域摘要列

位於主畫面上方，一行顯示：

| 項目 | 說明 |
|------|------|
| 監控狀態 | `監控中`（綠色）或 `已停止`（黃色） |
| 活躍 lot 數 | 目前持倉筆數 |
| 總持倉股數 | 所有活躍 lot 的股數加總 |
| 總未實現損益% | 以有價 lot 計算；若部分無即時價會標註（M/N 有價） |

無持倉時顯示「已停止 ｜ 無持倉」，有歷史交易則附帶筆數提示。

### 如何看盤

1. **全域摘要**：一眼掌握整體持倉狀態與損益方向
2. **Lot 看板**（主視圖）：每筆 lot 的現價、來源、phase、策略門檻與距離%
3. **庫存查詢彈窗**：詳細策略看板 + 一句狀態文案

不再有雙重重複顯示，所有細節集中在 Lot 看板。

## Lot 監控看板 — 策略現況顯示（v0.1.9 新增）

### 持倉清單看板

每筆 lot 卡片顯示以下資訊：

| 欄位 | 說明 |
|------|------|
| Lot# / 股號 | 倉位 ID 與對應股票代號 |
| 狀態標籤 | `持有中`（藍色）或 `停利追蹤`（綠色） |
| 買入價 × 股數 | 進場資訊 |
| 現價 | 即時現價，來自 lot.stock 對應的報價 |
| 來源 + 更新時間 | TWSE / Yahoo / Stooq + 最後更新時間戳 |
| 損益% | 未實現報酬率，漲綠跌紅 |

若該 lot 股號查無即時價，顯示「無即時價」，來源欄位顯示「—」。

### 策略門檻與距離

每筆 lot 卡片底部顯示策略門檻標籤：

| 標籤 | 計算方式 | 說明 |
|------|----------|------|
| 停損 $X 距 Y% | buyPrice × 0.9 | 距停損線的百分比距離 |
| 進停利 $X 差 Y% | buyPrice × 1.1 | 持有中：距進入停利模式的距離 |
| 回撤賣 $X 距 Y% | highestPrice × 0.92 | 停利追蹤中：距回撤賣出線的距離 |
| 最高 $X | highestPrice | 停利追蹤中：追蹤到的最高價 |

### 顏色提示

- 🟢 **綠色**（安全）：距門檻 > 5%
- 🟡 **黃色**（警戒）：距門檻 2~5%
- 🔴 **紅色**（危險）：距門檻 ≤ 2%
- 🔵 **藍色**（資訊）：無即時價或一般資訊

### 庫存查詢彈窗

每筆 lot 詳細資訊新增：
- 策略門檻標籤（同上）
- phase 狀態標籤（持有中 / 停利追蹤）
- 一句狀態文案（例：「持有觀望中，等待突破」「接近停損線，請留意風險」等）
- 若無即時價顯示「無即時價」+ 來源「—」

### 注意

- 僅為顯示層增強，**不改變**實際停損停利交易判斷邏輯
- 策略門檻值與交易引擎使用相同常數（STOP_LOSS=0.9, ENTER_TP=1.1, TP_EXIT=0.92）

## 分筆分股號比價（v0.1.8 新增）

- 每個 lot 記錄自己的 `stock` 股號，策略判斷使用該 lot 對應股號的即時價格
- 監控循環中，先整理所有 active lots 的唯一股號清單，平行抓取各股號現價
- 建立 symbol→price map，每個 lot 用自己 symbol 的價格套策略
- 若某股號查不到現價：只跳過該股號相關 lots 的交易判斷，其他有價的股號繼續判斷
- 日誌明確記錄哪個股號被跳過
- 持倉清單新增「股號」與「現價」欄位，每筆 lot 顯示各自現價與未實現損益
- 查詢庫存彈窗每筆 lot 獨立顯示現價（含來源）與損益；若無即時價顯示「無即時價」
- 手動賣出（單筆或全部）改為按 lot 各自的股號取價
- 舊存檔中若 lot 缺少 `stock` 欄位，自動以當前 `state.stock` 補值

## 移除模擬模式 / 無價格不交易（v0.1.7 新增）

- 完全移除模擬價格模式（random walk fallback），不再產生虛擬價格
- 所有交易動作（手動買入、自動策略賣出、手動賣出）都必須先有有效現價
- 若所有來源皆查不到現價：不執行任何買賣，顯示明確訊息
- 輪詢持續嘗試抓取，但失敗時只記錄狀態，不觸發交易邏輯
- 查詢庫存時若抓不到新價格，沿用上次有效價格並標註「非即時」
- 若完全無有效價格，顯示「目前無可用現價」

## 停止監控 vs 手動賣出（v0.1.5 新增）

| 操作 | 行為 |
|------|------|
| **停止監控** | 僅停止輪詢（clearInterval），持倉狀態保留不變，不產生賣出交易，不影響統計 |
| **手動賣出** | 以當前價格平倉，記錄賣出交易，更新統計與日誌 |

### 停止監控後的狀態
- 即時狀態面板顯示「持有（未監控）」或「停利模式（未監控）」
- 查詢庫存仍可看到持倉資訊（會即時取價更新）
- localStorage 保存持倉狀態，重新開啟頁面後可按「開始監控」繼續或「手動賣出」平倉
- 「手動賣出」按鈕僅在有持倉時可用，無持倉時灰色 disabled

## 資料來源（現價來源優先序與 fallback 行為）

系統依下列優先順序嘗試取得即時現價，每個來源皆有 4 秒超時保護：

| 優先序 | 來源 | 說明 |
|--------|------|------|
| 1 | **TWSE** | TWSE 公開 API (`mis.twse.com.tw`)，支援上市 (tse) 與上櫃 (otc) |
| 2 | **Yahoo** | Yahoo Finance chart endpoint (`query1.finance.yahoo.com`)，取 regularMarketPrice |
| 3 | **Stooq** | Stooq CSV endpoint (`stooq.com`)，取收盤價欄位 |

### Fallback 行為
- 每次取價時從來源 1 開始嘗試，失敗即嘗試下一來源
- 若遇 CORS 問題，自動透過公開 proxy（allorigins、corsproxy.io）重試
- **無模擬模式**：所有來源皆失敗時不產生虛擬價格，僅記錄狀態
- **查不到現價不交易**：任何交易動作（買入/自動賣出/手動賣出）皆需有效現價，無現價時跳過
- UI 即時顯示當前使用的來源與最後更新時間
- 輪詢頻率可由使用者調整（預設 5 秒，最小 3 秒）

## 查詢庫存（v0.1.3 新增）

按「查詢庫存」按鈕可隨時查看目前持倉狀態，彈出面板顯示以下欄位：

| 欄位 | 說明 |
|------|------|
| 股票代號 | 目前監控/持有的股票 |
| 持有狀態 | 無持倉 / 持有中 / 停利模式 |
| 持有股數 | 依買入設定（預設 1,000 股） |
| 買入來源 | 手動買入 / 自動買入 |
| 買入價 | 進場價格 |
| 現價 | 最新報價（若監控中會即時更新） |
| 未實現損益 | (現價 − 買入價) × 股數 |
| 未實現報酬率 | (現價 − 買入價) / 買入價 × 100% |
| 最高價 | 停利模式下的追蹤最高價 |
| 最後更新時間 | 最近一次價格更新的時間 |
| 來源 | 價格來源（TWSE / Yahoo / Stooq） |

### 無持倉時
- 面板顯示「目前無持倉」
- 若有歷史交易記錄，同時顯示最近一次已實現交易摘要（買入價、賣出價、損益、報酬率、原因）

### 資料來源
- 優先使用目前 state + localStorage 已存資料
- 若正在監控中，會先觸發一次即時價格更新再顯示（失敗則沿用最近價格）
- 重新整理頁面後，查詢庫存仍可從 localStorage 載入正確資料

## 庫存存檔（localStorage）

v0.1.2 新增自動存檔功能，關閉頁面後下次可接續。

### 存檔欄位

| 欄位 | 說明 |
|------|------|
| stock | 當前股票代號 |
| phase | 策略階段（idle / holding / trailing / sold） |
| buyPrice | 買入價 |
| highestPrice | 追蹤最高價 |
| currentPrice | 最近一次現價 |
| shares | 持有股數（預設 1000） |
| buySource | 買入來源（manual / auto） |
| trades | 交易記錄（最多保留 100 筆），每筆含 buyPrice、sellPrice、pnl、returnPct、reason、shares、buySource |
| source / sourceTime | 最後使用的來源名稱與更新時間 |
| pollSec | 輪詢間隔（秒） |
| monitorStart / monitorEnd | 監控時窗起止時間（HH:MM） |

### 載入行為

- 啟動時自動從 `localStorage` 讀取存檔
- 若有持倉（holding / trailing），UI 顯示藍底提示「已載入上次庫存，可按『開始監控』繼續」
- **不會自動下單或自動開始輪詢**，須由使用者按「開始監控」繼續
- 若存檔資料格式不完整或損毀，會容錯填入預設值

### 清除存檔

- 按「清除存檔」按鈕 → 清掉 localStorage 中的持倉、統計、日誌、設定
- UI 即時回到全新初始狀態（股票代號 2330、輪詢 5 秒）

## 技術

- 純前端 HTML/CSS/JS，無需後端
- 手機友善 RWD 設計
- 無外部相依套件
- localStorage 存檔（try/catch 容錯，瀏覽器不支援時靜默降級）
