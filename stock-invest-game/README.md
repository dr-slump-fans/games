# 股市投資策略模擬器（台股盤中規則版）

v0.1.4

## 玩法

1. 輸入或選擇股票代號（預設 2330 台積電）
2. 設定監控時窗（預設 09:10~12:00，Asia/Taipei 時區）
3. 按「手動買入」— 輸入買入價（留空=現價）與股數，手動進場後自動監控賣出
4. 或按「開始監控」— 等待監控時窗內手動買入
5. 系統每 N 秒取價並在監控時窗內自動執行策略判斷
6. 按「停止」會強制賣出目前持有部位
7. 按「重置」清除所有統計

## 策略規則

### 持有模式
- 現價 ≤ 買入價 × 0.9 → **停損賣出**
- 現價 ≥ 買入價 × 1.1 → 進入**停利模式**

### 停利模式（移動停利）
- 持續追蹤最高價
- 現價 ≥ 最高價 × 0.998 時視為接近/突破，更新最高價
- 現價 ≤ 最高價 × 0.92 → **移動停利賣出**

### 賣出後
- 顯示本次報酬率與損益
- 累積統計：交易次數、勝率、平均報酬率、累積損益

## 指定監控時間（v0.1.4 新增）

- 可自訂監控起始時間（預設 09:10）與結束時間（預設 12:00）
- 時區固定 Asia/Taipei，週六日不執行
- 只在設定的時窗內執行策略判斷，時窗外顯示等待
- 設定值會存入 localStorage，重新開啟頁面保留

## 手動買入與自動監控賣出（v0.1.4 新增）

- 按「手動買入」按鈕，可輸入買入價格（留空則使用當前現價）與股數（預設 1000）
- 手動買入後進入持有狀態（holding），自動啟動監控與賣出邏輯
- 若已有持倉，禁止重複買入並彈出提示
- 持倉來源（手動買入 / 自動買入）會顯示在即時狀態面板與庫存查詢彈窗
- 賣出邏輯沿用原策略：停損 / 進停利模式 / 移動停利

## 資料來源（現價來源優先序與 fallback 行為）

系統依下列優先順序嘗試取得即時現價，每個來源皆有 4 秒超時保護：

| 優先序 | 來源 | 說明 |
|--------|------|------|
| 1 | **TWSE** | TWSE 公開 API (`mis.twse.com.tw`)，支援上市 (tse) 與上櫃 (otc) |
| 2 | **Yahoo** | Yahoo Finance chart endpoint (`query1.finance.yahoo.com`)，取 regularMarketPrice |
| 3 | **Stooq** | Stooq CSV endpoint (`stooq.com`)，取收盤價欄位 |
| 4 | **模擬** | 以隨機漫步產生模擬價格（±0.5%），UI 顯示黃色「模擬模式」標籤 |

### Fallback 行為
- 每次取價時從來源 1 開始嘗試，失敗即嘗試下一來源
- 若遇 CORS 問題，自動透過公開 proxy（allorigins、corsproxy.io）重試
- 所有來源皆失敗時才退回模擬模式
- UI 即時顯示當前使用的來源與最後更新時間
- 輪詢頻率可由使用者調整（預設 5 秒，最小 3 秒）
- 模擬模式下策略邏輯完全相同，僅價格為虛擬產生

## 查詢庫存（v0.1.3 新增）

按「查詢庫存」按鈕可隨時查看目前持倉狀態，彈出面板顯示以下欄位：

| 欄位 | 說明 |
|------|------|
| 股票代號 | 目前監控/持有的股票 |
| 持有狀態 | 無持倉 / 持有中 / 停利模式 |
| 持有股數 | 依買入設定（預設 1,000 股） |
| 買入來源 | 手動買入 / 自動買入 |
| 買入價 | 進場價格 |
| 現價 | 最新報價（若監控中會即時更新） |
| 未實現損益 | (現價 − 買入價) × 股數 |
| 未實現報酬率 | (現價 − 買入價) / 買入價 × 100% |
| 最高價 | 停利模式下的追蹤最高價 |
| 最後更新時間 | 最近一次價格更新的時間 |
| 來源 | 價格來源（TWSE / Yahoo / Stooq / 模擬） |

### 無持倉時
- 面板顯示「目前無持倉」
- 若有歷史交易記錄，同時顯示最近一次已實現交易摘要（買入價、賣出價、損益、報酬率、原因）

### 資料來源
- 優先使用目前 state + localStorage 已存資料
- 若正在監控中，會先觸發一次即時價格更新再顯示（失敗則沿用最近價格）
- 重新整理頁面後，查詢庫存仍可從 localStorage 載入正確資料

## 庫存存檔（localStorage）

v0.1.2 新增自動存檔功能，關閉頁面後下次可接續。

### 存檔欄位

| 欄位 | 說明 |
|------|------|
| stock | 當前股票代號 |
| phase | 策略階段（idle / holding / trailing / sold） |
| buyPrice | 買入價 |
| highestPrice | 追蹤最高價 |
| currentPrice | 最近一次現價 |
| shares | 持有股數（預設 1000） |
| buySource | 買入來源（manual / auto） |
| trades | 交易記錄（最多保留 100 筆），每筆含 buyPrice、sellPrice、pnl、returnPct、reason、shares、buySource |
| source / sourceTime | 最後使用的來源名稱與更新時間 |
| pollSec | 輪詢間隔（秒） |
| monitorStart / monitorEnd | 監控時窗起止時間（HH:MM） |

### 載入行為

- 啟動時自動從 `localStorage` 讀取存檔
- 若有持倉（holding / trailing），UI 顯示藍底提示「已載入上次庫存，可按『開始監控』繼續」
- **不會自動下單或自動開始輪詢**，須由使用者按「開始監控」繼續
- 若存檔資料格式不完整或損毀，會容錯填入預設值

### 清除存檔

- 按「清除存檔」按鈕 → 清掉 localStorage 中的持倉、統計、日誌、設定
- UI 即時回到全新初始狀態（股票代號 2330、輪詢 5 秒）

## 技術

- 純前端 HTML/CSS/JS，無需後端
- 手機友善 RWD 設計
- 無外部相依套件
- localStorage 存檔（try/catch 容錯，瀏覽器不支援時靜默降級）
