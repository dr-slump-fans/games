<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>è‚¡å¸‚æŠ•è³‡ç­–ç•¥æ¨¡æ“¬å™¨ï¼ˆå°è‚¡ç›¤ä¸­è¦å‰‡ç‰ˆï¼‰</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:#0f172a;color:#e2e8f0;padding:12px}
.wrap{max-width:520px;margin:0 auto}
h1{font-size:1.2rem;margin-bottom:4px}
.ver{font-size:.7rem;color:#64748b}
.sim-badge{display:none;background:#f59e0b;color:#000;font-weight:700;padding:2px 8px;border-radius:6px;font-size:.75rem;margin-left:6px}
.sim-badge.on{display:inline}

/* inputs */
.row{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.row input,.row select{background:#1e293b;border:1px solid #334155;color:#e2e8f0;border-radius:8px;padding:8px 10px;font-size:.95rem}
.row input{flex:1;min-width:80px}
.row select{min-width:100px}
button{background:#2563eb;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:.9rem;cursor:pointer;font-weight:600}
button:disabled{opacity:.4;cursor:default}
button.stop{background:#dc2626}
button.reset{background:#475569}

/* status panel */
.panel{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:12px;margin:10px 0}
.panel h2{font-size:.95rem;margin-bottom:8px;color:#94a3b8}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px}
.grid .lbl{font-size:.75rem;color:#64748b}
.grid .val{font-size:1rem;font-weight:700}
.val.up{color:#22c55e}
.val.down{color:#ef4444}
.val.neutral{color:#94a3b8}

/* stats */
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px 16px}

/* log */
.log-box{background:#111827;border:1px solid #334155;border-radius:10px;padding:10px;max-height:200px;overflow-y:auto;font-size:.78rem;line-height:1.5}
.log-box .entry{border-bottom:1px solid #1e293b;padding:3px 0}
.log-box .entry:last-child{border:none}
.log-entry-up{color:#22c55e}
.log-entry-down{color:#ef4444}

/* market status bar */
.market-bar{text-align:center;padding:6px;border-radius:8px;font-size:.8rem;font-weight:600;margin:8px 0}
.market-bar.open{background:#14532d;color:#4ade80}
.market-bar.closed{background:#422006;color:#fbbf24}

.back{display:inline-block;margin-bottom:8px;color:#38bdf8;text-decoration:none;font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <a class="back" href="../index.html">â† å›é¦–é </a>
  <h1>ğŸ“ˆ è‚¡å¸‚æŠ•è³‡ç­–ç•¥æ¨¡æ“¬å™¨ <span class="ver">v0.1.0</span></h1>
  <span id="simBadge" class="sim-badge">æ¨¡æ“¬æ¨¡å¼</span>

  <div id="marketBar" class="market-bar closed">éç›¤ä¸­æ™‚æ®µ â€” ç­‰å¾…é–‹ç›¤</div>

  <!-- stock input -->
  <div class="row">
    <input id="stockInput" type="text" placeholder="è‚¡ç¥¨ä»£è™Ÿ" value="2330"/>
    <select id="stockSelect">
      <option value="2330">2330 å°ç©é›»</option>
      <option value="2317">2317 é´»æµ·</option>
      <option value="0050">0050 å…ƒå¤§å°ç£50</option>
      <option value="2454">2454 è¯ç™¼ç§‘</option>
    </select>
  </div>
  <div class="row">
    <button id="btnStart">é–‹å§‹ç›£æ§</button>
    <button id="btnStop" class="stop" disabled>åœæ­¢</button>
    <button id="btnReset" class="reset">é‡ç½®</button>
  </div>

  <!-- status -->
  <div class="panel">
    <h2>å³æ™‚ç‹€æ…‹</h2>
    <div class="grid">
      <div><div class="lbl">è‚¡ç¥¨</div><div class="val" id="dStock">â€”</div></div>
      <div><div class="lbl">ç¾åƒ¹</div><div class="val" id="dPrice">â€”</div></div>
      <div><div class="lbl">è²·å…¥åƒ¹</div><div class="val" id="dBuy">â€”</div></div>
      <div><div class="lbl">æœ€é«˜åƒ¹</div><div class="val" id="dHigh">â€”</div></div>
      <div><div class="lbl">ç‹€æ…‹</div><div class="val neutral" id="dState">ç­‰å¾…ä¸­</div></div>
      <div><div class="lbl">å ±é…¬ç‡</div><div class="val neutral" id="dReturn">â€”</div></div>
    </div>
  </div>

  <!-- cumulative stats -->
  <div class="panel">
    <h2>ç´¯ç©çµ±è¨ˆ</h2>
    <div class="stats">
      <div><div class="lbl">äº¤æ˜“æ¬¡æ•¸</div><div class="val" id="sTrades">0</div></div>
      <div><div class="lbl">å‹ç‡</div><div class="val" id="sWinRate">â€”</div></div>
      <div><div class="lbl">å¹³å‡å ±é…¬ç‡</div><div class="val" id="sAvgReturn">â€”</div></div>
      <div><div class="lbl">ç´¯ç©æç›Š</div><div class="val neutral" id="sTotalPnl">$0</div></div>
    </div>
  </div>

  <!-- trade log -->
  <div class="panel">
    <h2>äº¤æ˜“æ—¥èªŒ</h2>
    <div class="log-box" id="logBox"><div class="entry" style="color:#64748b">å°šç„¡äº¤æ˜“è¨˜éŒ„</div></div>
  </div>
</div>

<script>
/* â”€â”€ Config â”€â”€ */
const SHARES = 1000;
const STOP_LOSS = 0.9;       // sell if price <= buyPrice * 0.9
const ENTER_TP = 1.1;        // enter trailing-stop mode at +10%
const NEAR_HIGH = 0.998;     // treat as new high if >= highest * 0.998
const TP_EXIT = 0.92;        // sell if price <= highestPrice * 0.92
const POLL_MS = 5000;        // poll interval
const MARKET_OPEN_H = 9, MARKET_OPEN_M = 10;
const MARKET_CLOSE_H = 12, MARKET_CLOSE_M = 0;

/* â”€â”€ State â”€â”€ */
let state = resetState();
let timer = null;
let simMode = false;
let simPrice = 0;

function resetState() {
  return {
    stock: '2330',
    phase: 'idle',       // idle | holding | trailing | sold
    buyPrice: 0,
    highestPrice: 0,
    currentPrice: 0,
    trades: [],          // {buyPrice, sellPrice, pnl, returnPct, reason}
  };
}

/* â”€â”€ DOM refs â”€â”€ */
const $ = id => document.getElementById(id);
const btnStart = $('btnStart'), btnStop = $('btnStop'), btnReset = $('btnReset');
const stockInput = $('stockInput'), stockSelect = $('stockSelect');

stockSelect.addEventListener('change', () => { stockInput.value = stockSelect.value; });
stockInput.addEventListener('input', () => {
  const v = stockInput.value.trim();
  if ([...stockSelect.options].some(o => o.value === v)) stockSelect.value = v;
});

btnStart.addEventListener('click', startMonitor);
btnStop.addEventListener('click', stopMonitor);
btnReset.addEventListener('click', doReset);

/* â”€â”€ Market hours check (Asia/Taipei) â”€â”€ */
function taipeiNow() {
  return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
}
function isMarketOpen() {
  const d = taipeiNow();
  const day = d.getDay();
  if (day === 0 || day === 6) return false;
  const mins = d.getHours() * 60 + d.getMinutes();
  return mins >= MARKET_OPEN_H * 60 + MARKET_OPEN_M && mins < MARKET_CLOSE_H * 60 + MARKET_CLOSE_M;
}
function updateMarketBar() {
  const bar = $('marketBar');
  if (isMarketOpen()) {
    bar.className = 'market-bar open';
    bar.textContent = 'ç›¤ä¸­äº¤æ˜“æ™‚æ®µ 09:10 â€“ 12:00';
  } else {
    bar.className = 'market-bar closed';
    bar.textContent = 'éç›¤ä¸­æ™‚æ®µ â€” ç­‰å¾…é–‹ç›¤';
  }
}

/* â”€â”€ Price fetching â”€â”€ */
async function fetchPrice(stock) {
  // Try public TWSE API (mis.twse.com.tw) â€” returns JSON with CORS headers
  try {
    const ts = Date.now();
    const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_${stock}.tw&_=${ts}`;
    const resp = await fetch(url, { signal: AbortSignal.timeout(4000) });
    if (!resp.ok) throw new Error('http ' + resp.status);
    const json = await resp.json();
    if (json.msgArray && json.msgArray.length > 0) {
      const info = json.msgArray[0];
      // z = last trade price, if "â€“" use y (yesterday close)
      let price = parseFloat(info.z);
      if (isNaN(price) || price <= 0) price = parseFloat(info.y);
      if (isNaN(price) || price <= 0) throw new Error('no price in response');
      enableSimMode(false);
      return price;
    }
    throw new Error('empty msgArray');
  } catch (_e1) {
    // Try OTC market (tpex)
    try {
      const ts = Date.now();
      const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=otc_${stock}.tw&_=${ts}`;
      const resp = await fetch(url, { signal: AbortSignal.timeout(4000) });
      if (!resp.ok) throw new Error('http ' + resp.status);
      const json = await resp.json();
      if (json.msgArray && json.msgArray.length > 0) {
        const info = json.msgArray[0];
        let price = parseFloat(info.z);
        if (isNaN(price) || price <= 0) price = parseFloat(info.y);
        if (isNaN(price) || price <= 0) throw new Error('no price');
        enableSimMode(false);
        return price;
      }
      throw new Error('empty');
    } catch (_e2) {
      // fallback: simulation mode
      return simulatedPrice(stock);
    }
  }
}

function simulatedPrice(stock) {
  enableSimMode(true);
  if (simPrice <= 0) {
    // seed based on stock â€” rough defaults
    const seeds = { '2330': 900, '2317': 170, '0050': 160, '2454': 1200 };
    simPrice = seeds[stock] || 500;
  }
  // random walk: Â±0.5%
  const change = simPrice * (Math.random() - 0.5) * 0.01;
  simPrice = Math.round((simPrice + change) * 100) / 100;
  if (simPrice < 1) simPrice = 1;
  return simPrice;
}

function enableSimMode(on) {
  if (simMode === on) return;
  simMode = on;
  $('simBadge').className = 'sim-badge' + (on ? ' on' : '');
}

/* â”€â”€ Core loop â”€â”€ */
async function tick() {
  updateMarketBar();

  // Fetch price regardless (to show current price), but only run strategy during market hours
  let price;
  try {
    price = await fetchPrice(state.stock);
  } catch { return; }

  state.currentPrice = price;
  renderPrice();

  if (!isMarketOpen()) return;  // no strategy outside market hours

  if (state.phase === 'idle') {
    // auto-buy on first tick during market hours
    state.buyPrice = price;
    state.highestPrice = price;
    state.phase = 'holding';
    addLog(`è²·å…¥ ${SHARES} è‚¡ @ $${price}`, 'neutral');
  }

  if (state.phase === 'holding') {
    if (price <= state.buyPrice * STOP_LOSS) {
      executeSell(price, 'åœæ');
    } else if (price >= state.buyPrice * ENTER_TP) {
      state.phase = 'trailing';
      state.highestPrice = price;
      addLog(`é€²å…¥åœåˆ©æ¨¡å¼ (ç¾åƒ¹ $${price}, è²·å…¥ $${state.buyPrice})`, 'neutral');
    }
  }

  if (state.phase === 'trailing') {
    if (price >= state.highestPrice * NEAR_HIGH) {
      state.highestPrice = Math.max(state.highestPrice, price);
    }
    if (price <= state.highestPrice * TP_EXIT) {
      executeSell(price, 'ç§»å‹•åœåˆ©');
    }
  }

  renderAll();
}

function executeSell(price, reason) {
  const pnl = (price - state.buyPrice) * SHARES;
  const returnPct = ((price - state.buyPrice) / state.buyPrice) * 100;
  const trade = { buyPrice: state.buyPrice, sellPrice: price, pnl, returnPct, reason };
  state.trades.push(trade);
  state.phase = 'sold';
  const sign = pnl >= 0 ? '+' : '';
  addLog(
    `è³£å‡º ${SHARES} è‚¡ @ $${price}ï¼ˆ${reason}ï¼‰å ±é…¬ ${sign}${returnPct.toFixed(2)}%  æç›Š ${sign}$${pnl.toFixed(0)}`,
    pnl >= 0 ? 'up' : 'down'
  );
}

/* â”€â”€ Start / Stop / Reset â”€â”€ */
function startMonitor() {
  state.stock = stockInput.value.trim() || '2330';
  state.phase = 'idle';
  state.buyPrice = 0;
  state.highestPrice = 0;
  simPrice = 0;
  btnStart.disabled = true;
  btnStop.disabled = false;
  stockInput.disabled = true;
  stockSelect.disabled = true;
  addLog(`é–‹å§‹ç›£æ§ ${state.stock}`, 'neutral');
  tick();
  timer = setInterval(tick, POLL_MS);
}

function stopMonitor() {
  clearInterval(timer);
  timer = null;
  btnStart.disabled = false;
  btnStop.disabled = true;
  stockInput.disabled = false;
  stockSelect.disabled = false;
  if (state.phase === 'holding' || state.phase === 'trailing') {
    // force sell at current price
    executeSell(state.currentPrice, 'æ‰‹å‹•åœæ­¢');
    renderAll();
  }
  addLog('ç›£æ§å·²åœæ­¢', 'neutral');
  state.phase = 'idle';
}

function doReset() {
  stopMonitor();
  state = resetState();
  simPrice = 0;
  enableSimMode(false);
  $('logBox').innerHTML = '<div class="entry" style="color:#64748b">å°šç„¡äº¤æ˜“è¨˜éŒ„</div>';
  renderAll();
  addLog('å·²é‡ç½®', 'neutral');
}

/* â”€â”€ Render â”€â”€ */
function renderPrice() {
  $('dStock').textContent = state.stock;
  $('dPrice').textContent = state.currentPrice ? `$${state.currentPrice.toFixed(2)}` : 'â€”';
}

function renderAll() {
  renderPrice();
  $('dBuy').textContent = state.buyPrice ? `$${state.buyPrice.toFixed(2)}` : 'â€”';
  $('dHigh').textContent = state.highestPrice ? `$${state.highestPrice.toFixed(2)}` : 'â€”';

  // state label
  const labels = { idle: 'ç­‰å¾…ä¸­', holding: 'æŒæœ‰', trailing: 'åœåˆ©æ¨¡å¼', sold: 'å·²è³£å‡º' };
  const el = $('dState');
  el.textContent = labels[state.phase] || 'â€”';
  el.className = 'val ' + (state.phase === 'trailing' ? 'up' : state.phase === 'sold' ? 'neutral' : 'neutral');

  // current return
  const retEl = $('dReturn');
  if (state.phase === 'holding' || state.phase === 'trailing') {
    const pct = ((state.currentPrice - state.buyPrice) / state.buyPrice) * 100;
    retEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
    retEl.className = 'val ' + (pct >= 0 ? 'up' : 'down');
  } else if (state.phase === 'sold' && state.trades.length > 0) {
    const last = state.trades[state.trades.length - 1];
    retEl.textContent = (last.returnPct >= 0 ? '+' : '') + last.returnPct.toFixed(2) + '%';
    retEl.className = 'val ' + (last.returnPct >= 0 ? 'up' : 'down');
  } else {
    retEl.textContent = 'â€”';
    retEl.className = 'val neutral';
  }

  // cumulative stats
  const t = state.trades;
  $('sTrades').textContent = t.length;
  if (t.length > 0) {
    const wins = t.filter(x => x.pnl > 0).length;
    $('sWinRate').textContent = (wins / t.length * 100).toFixed(1) + '%';
    const avgRet = t.reduce((s, x) => s + x.returnPct, 0) / t.length;
    const avgEl = $('sAvgReturn');
    avgEl.textContent = (avgRet >= 0 ? '+' : '') + avgRet.toFixed(2) + '%';
    avgEl.className = 'val ' + (avgRet >= 0 ? 'up' : 'down');
    const totalPnl = t.reduce((s, x) => s + x.pnl, 0);
    const pnlEl = $('sTotalPnl');
    pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(0);
    pnlEl.className = 'val ' + (totalPnl >= 0 ? 'up' : 'down');
  } else {
    $('sWinRate').textContent = 'â€”';
    $('sAvgReturn').textContent = 'â€”';
    $('sAvgReturn').className = 'val neutral';
    $('sTotalPnl').textContent = '$0';
    $('sTotalPnl').className = 'val neutral';
  }
}

function addLog(msg, type) {
  const box = $('logBox');
  // remove placeholder
  if (box.querySelector('.entry[style]')) box.innerHTML = '';
  const now = taipeiNow();
  const ts = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const cls = type === 'up' ? 'log-entry-up' : type === 'down' ? 'log-entry-down' : '';
  const div = document.createElement('div');
  div.className = 'entry ' + cls;
  div.textContent = `[${ts}] ${msg}`;
  box.prepend(div);
}

/* â”€â”€ Init â”€â”€ */
updateMarketBar();
setInterval(updateMarketBar, 30000);
renderAll();
</script>
</body>
</html>
